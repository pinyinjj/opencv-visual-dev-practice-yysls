name: Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      major_version:
        description: 'Major version (e.g., 2.0.0) - leave empty for auto minor version'
        required: false
        type: string

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Get version info
      id: version
      run: |
        # Get latest tag
        $latestTag = git describe --tags --abbrev=0 2>$null
        if (-not $latestTag) {
          $latestTag = "v0.0.0"
        }
        Write-Host "Latest tag: $latestTag"
        
        # Extract version number
        $versionNumber = $latestTag -replace "v", ""
        $versionParts = $versionNumber -split "\."
        $major = [int]$versionParts[0]
        $minor = [int]$versionParts[1]
        $patch = [int]$versionParts[2]
        
        # Check if major version is specified
        $inputMajor = "${{ github.event.inputs.major_version }}"
        if ($inputMajor -and $inputMajor -ne "") {
          $newVersion = $inputMajor
          Write-Host "Using specified major version: $newVersion"
        } else {
          # Auto increment minor version
          $minor++
          $patch = 0
          $newVersion = "v$major.$minor.$patch"
          Write-Host "Auto incrementing minor version: $newVersion"
        }
        
        echo "VERSION=$newVersion" >> $env:GITHUB_OUTPUT
        echo "TAG_NAME=$newVersion" >> $env:GITHUB_OUTPUT
        echo "RELEASE_NAME=YYSLS OpenCV Template $newVersion" >> $env:GITHUB_OUTPUT
        echo "VERSION_NUMBER=$($newVersion -replace 'v', '')" >> $env:GITHUB_OUTPUT
    
    - name: Create version file
      run: |
        echo "VERSION=${{ steps.version.outputs.VERSION_NUMBER }}" > version.txt
        echo "BUILD_DATE=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> version.txt
        echo "COMMIT_SHA=${{ github.sha }}" >> version.txt
    
    - name: Build executable
      run: |
        python build_exe.py
    
    - name: Create release assets
      run: |
        # Create release directory
        mkdir release
        
        # Copy executable
        copy "dist\yysls-opencv-template-v2.exe" "release\yysls-opencv-template-${{ steps.version.outputs.VERSION_NUMBER }}.exe"
        
        # Copy config and templates
        copy "crop_config.json" "release\"
        xcopy "templates" "release\templates\" /E /I
        
        # Create README for release
        @"
# YYSLS OpenCV Template ${{ steps.version.outputs.VERSION_NUMBER }}

## ä½¿ç”¨æ–¹æ³•

1. è¿è¡Œ `yysls-opencv-template-${{ steps.version.outputs.VERSION_NUMBER }}.exe`
2. ç¨‹åºä¼šè¦æ±‚ç®¡ç†å‘˜æƒé™ï¼Œè¯·å…è®¸
3. å¯åŠ¨åä¼šæ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
4. åœ¨ç³»ç»Ÿæ‰˜ç›˜æ‰¾åˆ°è“è‰²åœ†å½¢å›¾æ ‡
5. å³é”®ç‚¹å‡»å›¾æ ‡è¿›è¡Œæ§åˆ¶

## åŠŸèƒ½

- è‡ªåŠ¨QTEæ£€æµ‹
- ç³»ç»Ÿæ‰˜ç›˜æ§åˆ¶
- é¢„è§ˆçª—å£åˆ‡æ¢
- æŒ‰é”®æ“ä½œå¼€å…³
- ç®¡ç†å‘˜æƒé™è¿è¡Œ

## æ–‡ä»¶è¯´æ˜

- `yysls-opencv-template-${{ steps.version.outputs.VERSION_NUMBER }}.exe` - ä¸»ç¨‹åº
- `crop_config.json` - é…ç½®æ–‡ä»¶
- `templates/` - æ¨¡æ¿æ–‡ä»¶å¤¹

## ç‰ˆæœ¬ä¿¡æ¯

- ç‰ˆæœ¬: ${{ steps.version.outputs.VERSION_NUMBER }}
- æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- æäº¤: ${{ github.sha }}
"@ | Out-File -FilePath "release\README.md" -Encoding UTF8
    
    - name: Create Git tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ steps.version.outputs.TAG_NAME }}
        git push origin ${{ steps.version.outputs.TAG_NAME }}
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.TAG_NAME }}
        name: ${{ steps.version.outputs.RELEASE_NAME }}
        body: |
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### ä¸»è¦åŠŸèƒ½
          - âœ… è‡ªåŠ¨QTEæ£€æµ‹
          - âœ… ç³»ç»Ÿæ‰˜ç›˜æ§åˆ¶
          - âœ… é¢„è§ˆçª—å£åˆ‡æ¢
          - âœ… æŒ‰é”®æ“ä½œå¼€å…³
          - âœ… ç®¡ç†å‘˜æƒé™è¿è¡Œ
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `yysls-opencv-template-${{ steps.version.outputs.VERSION_NUMBER }}.exe`
          2. ä¸‹è½½ `crop_config.json` å’Œ `templates/` æ–‡ä»¶å¤¹
          3. å°†æ‰€æœ‰æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
          4. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          
          ### ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ steps.version.outputs.VERSION_NUMBER }}
          - **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - **æäº¤**: ${{ github.sha }}
          
          ### æ›´æ–°æ—¥å¿—
          - é‡æ„ä»£ç æ¶æ„ï¼Œç§»é™¤å…¨å±€å˜é‡
          - æ·»åŠ ç³»ç»Ÿæ‰˜ç›˜åŠŸèƒ½
          - å®ç°å¯åŠ¨é€šçŸ¥
          - ä¼˜åŒ–æ„å»ºæµç¨‹
        files: |
          release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
